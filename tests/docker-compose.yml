version: '3'
# This file helps run services so we can run integration tests.
# For testing: docker-compose up --abort-on-container-exit --exit-code-from pytest
# To see exit code: echo Exit Code is %errorlevel%
# For usage: docker-compose up -d

services:

  pytest:
    build:
      context: ..
      dockerfile: tests/Dockerfile.pytest
    command: bash -c "/wait-for-it.sh dynamodb:8000 -- && cd /tests/ && DYNAMODB_LOCAL_URL='http://dynamodb:8000' pytest -x"

  dynamodb:
    image: amazon/dynamodb-local
    ports:
      - '8000:8000'
    # Instead od using in-memory DB, we could also persist data:
    #   -sharedDb -dbPath /home/dynamodblocal/data/
    # volumes:
    #   - static-content:/usr/src/app
    command: -jar DynamoDBLocal.jar -inMemory -port 8000

  minio:
    image: minio/minio
    ports:
      - '9000:9000'
    volumes:
      - minio-data:/export
    command: server /export
    environment:
      MINIO_ACCESS_KEY: localS3Credentials
      MINIO_SECRET_KEY: localS3Credentials
    
  createbuckets:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add openEo http://minio:9000 localS3Credentials localS3Credentials;
      /usr/bin/mc rm -r --force openEo/results;
      /usr/bin/mc mb openEo/results;
      /usr/bin/mc policy download openEo/results;
      exit 0;
      "

volumes:
  minio-data:
